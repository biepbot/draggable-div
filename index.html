<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link href="css/index.css" rel="stylesheet" />
    <link href="css/board.css" rel="stylesheet" />
  </head>
  <script type="module" src="./js/draggable_div.mjs"></script>
  <script type="module" src="./js/free_draggable_div.mjs"></script>
  <body>
    <h1>Draggable div</h1>

    <h2>Basic</h2>
    <div class="flex-box">
      <draggable-div class="drag-child" draggable-horizontal>
        <span>easily set up</span>
        <span>without any kind</span>
        <span>of adjustments</span>
      </draggable-div>
      <draggable-div class="draggable-no-flex drag-li" draggable="li" into="ul">
        <p>Shopping list</p>
        <ul>
          <li>2 loafs of bread</li>
          <li>3 jugs of milk</li>
          <li>2kg bananas</li>
          <li>2 chocolate spread</li>
          <li>8 pickles</li>
        </ul>
      </draggable-div>
    </div>

    <h2>Swimlane</h2>
    <draggable-div
      id="drag-div"
      draggable=".draggable"
      into=".wrapper"
      lane-horizontal
    >
      <div class="lane" lane="TO DO">
        <p>TO DO</p>
        <div class="wrapper"></div>
      </div>
      <div class="lane" lane="PROGRESS">
        <p>PROGRESS</p>
        <div class="wrapper"></div>
      </div>
      <div class="lane" lane="REVIEW">
        <p>REVIEW</p>
        <div class="wrapper"></div>
      </div>
      <div class="lane" lane="CLOSED">
        <p>CLOSED</p>
        <div class="wrapper"></div>
      </div>
    </draggable-div>
    <div class="flex-box input">
      <input id="task-add" type="text" oninput />
      <button id="task-add-button" onclick="swimLaneInputCallback();">
        Add item
      </button>
    </div>
    <script>
      const drag = document.getElementById("drag-div");
      const input = document.getElementById("task-add");
      input.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          swimLaneInputCallback();
        }
      });

      let items = {};

      function swimLaneInputCallback() {
        let value = input.value.trim();
        input.value = "";
        if (value in items) return;
        add({ value, lane: "TO DO" });
        save();
      }

      function add(item) {
        const laneWrapper = drag.querySelector(
          `[lane='${item.lane}'] .wrapper`
        );

        // <div class="draggable">Eat bread</div>
        const div = document.createElement("div");
        div.classList.add("draggable");

        // Add text
        const p = document.createElement("p");
        p.innerText = item.value;
        p.classList.add("text");
        div.appendChild(p);

        // Add delete button
        const deleteDiv = document.createElement("div");
        deleteDiv.innerText = "x";
        deleteDiv.classList.add("delete");
        deleteDiv.addEventListener("pointerdown", () => {
          // Remove self
          div.remove();

          // Remove item
          delete items[item.value];

          // Save
          save();
        });
        div.appendChild(deleteDiv);

        laneWrapper.appendChild(div);

        // Add to items
        items[item.value] = item.lane;
      }

      function save() {
        localStorage.setItem("taskList", JSON.stringify(items));
      }

      function load() {
        let rawItems = localStorage.getItem("taskList");
        if (rawItems) {
          items = JSON.parse(rawItems);
          for (const item in items) {
            add({ value: item, lane: items[item] });
          }
        }
      }

      window.addEventListener("load", load);
      drag.addEventListener("change", (evt) => {
        const element = evt.detail;
        let value = element.querySelector("p.text").innerText;

        let newLane = element.parentElement.parentElement.getAttribute("lane");
        if (!newLane) {
          console.error("Swimlane structure has changed?");
          return;
        }

        items[value] = newLane;
        save();
      });
    </script>

    <h2>Board</h2>
    <free-draggable-div id="board"></free-draggable-div>
    <div class="flex-box input">
      <input id="board-task-add" type="text" oninput />
      <button onclick="boardInputCallback();">Add note</button>
    </div>
    <script>
      const boardInput = document.getElementById("board-task-add");
      const board = document.getElementById("board");
      boardInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          boardInputCallback();
        }
      });

      function boardInputCallback() {
        let value = boardInput.value.trim();
        input.value = "";

        /*
        <a href="#" contenteditable>
          <h2>Title #1</h2>
          <p>Text Content #1</p>
        </a>  
        */

        const note = document.createElement("a");
        note.classList.add("sticky-note");
        note.href = "#";
        note.contentEditable = true;
        const p = document.createElement("p");
        p.innerText = value;
        note.appendChild(p);
        board.appendChild(note);
      }
    </script>
  </body>
</html>
